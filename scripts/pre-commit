#!/bin/sh

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

# If no Go files are staged, exit successfully
if [ -z "$STAGED_GO_FILES" ]; then
    echo "No Go files staged for commit"
    exit 0
fi

echo "Staged Go files:"
echo "$STAGED_GO_FILES"

# Run go fmt on staged files only
echo "Running go fmt on staged files..."
for file in $STAGED_GO_FILES; do
    if [ -f "$file" ]; then
        go fmt "$file"
        if [ $? -ne 0 ]; then
            echo "go fmt failed on $file"
            exit 1
        fi
        # Re-stage the formatted file
        git add "$file"
    fi
done

# Run golangci-lint on directories containing staged files
echo "Running golangci-lint..."
# Extract unique directories from staged files
STAGED_DIRS=$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u)

# Run golangci-lint on each directory
for dir in $STAGED_DIRS; do
    echo "Linting directory: $dir"
    golangci-lint run "$dir"
    if [ $? -ne 0 ]; then
        echo "golangci-lint failed in $dir"
        exit 1
    fi
done

echo "Pre-commit checks passed!"
exit 0
